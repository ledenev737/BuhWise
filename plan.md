# План разработки BuhWise

Этот документ описывает архитектуру, данные и очередность работ для реализации Windows‑приложения бухгалтерии по USD/EUR/RUB.

## Технологии
- UI: .NET 8, WPF (тёмная тема, локализация RU). 
- Доступ к данным: SQLite через EF Core (SQLite provider). 
- Форматы обмена: CSV для экспорта (MVP), возможность расширить до Excel. 
- Локальные настройки и последние курсы — в базе.

## Структура данных (черновик схемы)
- **Currencies**: код (USD/EUR/RUB), имя, порядок отображения. Предзаполняется и редактируется только для курсов.
- **ExchangeRates**: Id, CurrencyCode, RateToUsd, AppliedAtUtc (дата фиксации), IsCurrent. Позволяет хранить историю курсов; «последний» курс берётся по IsCurrent/AppliedAtUtc.
- **Operations**:
  - Id (GUID)
  - OccurredAt (дата/время операции)
  - Type (Income/Expense/Exchange)
  - FromCurrency, FromAmount
  - ToCurrency, ToAmount (nullable — только для обмена)
  - Rate (коэффициент From→To, фиксируется на момент операции)
  - CommissionValue (nullable), CommissionKind (None/Percent/Fixed)
  - UsdEquivalent (decimal, фиксируется при сохранении)
  - CategoryId (nullable), Note, CreatedAt/UpdatedAt
- **Categories**: Id, Name, Type (Income/Expense/Both), IsArchived.
- **Settings**: Key/Value (JSON) — хранить путь/частоту бэкапа, последний выбранный курс.
- **Backups**: таблица для регистрации резервных копий (дата, путь) для логирования.

## Доменные правила
- Баланс вычисляется накоплением операций: 
  - Income → +FromAmount в FromCurrency. 
  - Expense → −FromAmount в FromCurrency. 
  - Exchange → −FromAmount в FromCurrency; +ToAmount в ToCurrency. 
- ToAmount вычисляется при вводе: `FromAmount * Rate` (минус комиссия, если она в исходной валюте; при фиксированной комиссии в целевой валюте нужно отразить в обеих валютах). Комиссию хранить в полях CommissionValue/CommissionKind и учитывать при расчёте остатка.
- Исторические операции не пересчитываются при обновлении курсов; пересчитывается только текущий сводный баланс (для USD) по актуальным курсам.
- Все суммы и курсы — decimal(18,4) или выше, суммы итогов — decimal(18,2).

## UI и сценарии (MVP)
- Верхняя панель: текущие остатки USD/EUR/RUB и свод в USD.
- Форма операций: 
  - Тип (доход/расход/обмен), дата, суммы, валюты, курс, комиссия (процент/фикс/нет), категория, примечание. 
  - Подстановка последнего курса выбранной пары с возможностью правки. 
  - Расчёт ToAmount и USD-эквивалента в реальном времени. 
- История операций с фильтрами: период, тип, валюта, категория. 
- Отчёты: свод по валютам и по типу, эквивалент в USD. 
- Управление курсами: форма «Обновить курсы» для ручного ввода текущих значений.
- Экспорт в CSV: текущая выборка операций и отчёт по балансу.
- Настройки: каталог для БД и резервных копий, частота бэкапа (при выходе/периодически), опциональный пароль (MVP можно отложить).

## Очередность задач
1) **Инфраструктура проекта**: создать WPF-проект, настроить стиль/тему, добавить EF Core и конфигурацию SQLite, миграции. 
2) **Схема БД**: реализовать модели/миграции для таблиц выше; сидировать валюты и категории по умолчанию. 
3) **Сервис баланса**: расчёт остатков по операциям и конвертация в USD по текущим курсам.
4) **CRUD операций**: форма создания/редактирования, учёт комиссии, автоподстановка курса. 
5) **История и фильтры**: таблица с сортировкой и фильтрами по дате/типу/валюте/категории. 
6) **Управление курсами**: форма ручного ввода, переключение «текущий» курс. 
7) **Отчёты и экспорт**: сводные данные + экспорт CSV; сохранение последнего пути. 
8) **Бэкапы**: сервис копирования файла БД, настройка расписания/при выходе. 
9) **Минимальная защита**: опциональный пароль на запуск (можно флагом в настройках). 

## Риски и решения
- **Точность расчётов**: использовать decimal и инвариантную культуру для парсинга/форматирования.
- **Конкурентность БД**: одиночный пользователь → достаточно WAL и единичных соединений.
- **Миграции/резервные копии**: бэкап перед миграцией, логирование успешных копий.

## Критерии готовности MVP
- Все три типа операций сохраняются в БД с фиксированным курсом и комиссией. 
- Остатки по трём валютам корректно обновляются после каждой операции. 
- Сводный баланс в USD рассчитывается из текущих курсов, история не меняется. 
- Работают фильтры и экспорт CSV. 
- Ручное обновление курсов и резервное копирование доступны из интерфейса.
